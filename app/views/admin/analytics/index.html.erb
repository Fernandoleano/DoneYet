<div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-900 to-indigo-950 py-10 px-6">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-10 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-purple-700 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-900/50">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
        </div>
        <div>
          <h1 class="text-5xl font-black text-white mb-1 bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">Operations Analytics</h1>
          <p class="text-gray-400 text-lg">System-wide behavior and event tracking</p>
        </div>
      </div>
      <%= link_to admin_path, class: "group px-6 py-3 bg-gray-800/50 hover:bg-gray-700/50 border border-gray-700 hover:border-gray-600 rounded-xl font-semibold transition-all flex items-center gap-2" do %>
        <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        Back to Dashboard
      <% end %>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
      <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700 rounded-2xl p-6">
        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Total Visits</p>
        <p class="text-4xl font-black text-white tabular-nums"><%= @total_visits %></p>
      </div>
      <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700 rounded-2xl p-6">
        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Total Events</p>
        <p class="text-4xl font-black text-white tabular-nums"><%= @total_events %></p>
      </div>
      <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700 rounded-2xl p-6">
        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Recent Visitors</p>
        <div class="flex -space-x-2 mt-2">
          <% @recent_visits.map(&:user).compact.uniq.take(5).each do |user| %>
            <% if user.avatar.attached? %>
              <%= image_tag user.avatar, class: "w-9 h-9 rounded-full border-2 border-gray-800 object-cover" %>
            <% else %>
              <div class="w-9 h-9 bg-indigo-600 rounded-full border-2 border-gray-800 flex items-center justify-center text-xs font-bold">
                <%= user.name.first %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
      <!-- Visits Chart -->
      <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700 rounded-2xl p-8">
        <h2 class="text-2xl font-black text-white mb-6">Traffic (Last 7 Days)</h2>
        <div class="h-64">
          <canvas id="visitsChart"></canvas>
        </div>
      </div>

      <!-- Events Distribution -->
      <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700 rounded-2xl p-8">
        <h2 class="text-2xl font-black text-white mb-6">Event Distribution</h2>
        <div class="space-y-4">
          <% @events_by_name.take(6).each do |name, count| %>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-300 font-medium"><%= name %></span>
                <span class="text-white font-bold"><%= count %></span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-2">
                <% percentage = (count.to_f / @total_events * 100).round(1) %>
                <div class="bg-indigo-500 h-2 rounded-full" style="width: <%= percentage %>%"></div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Recent Activity Tables -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Recent Visits -->
      <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700 rounded-2xl overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-700 bg-gray-800/50 flex justify-between items-center">
          <h2 class="text-xl font-black text-white uppercase tracking-tight">Recent Sessions</h2>
          <%= link_to "View All", admin_analytics_visits_path, class: "text-indigo-400 text-sm font-bold hover:text-indigo-300 transition" %>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <tbody class="divide-y divide-gray-700/50">
              <% @recent_visits.each do |visit| %>
                <tr class="hover:bg-gray-700/30 transition-colors">
                  <td class="py-4 px-6">
                    <div class="flex items-center gap-3">
                      <% if visit.user %>
                        <span class="text-white font-bold"><%= visit.user.name %></span>
                      <% else %>
                        <span class="text-gray-500 font-medium italic">Anonymous</span>
                      <% end %>
                    </div>
                  </td>
                  <td class="py-4 px-6 text-gray-400 text-sm">
                    <%= visit.started_at.strftime("%b %d, %H:%M") %>
                  </td>
                  <td class="py-4 px-6 text-gray-500 font-mono text-xs">
                    <%= visit.ip %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Most Active Users -->
      <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700 rounded-2xl overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-700 bg-gray-800/50">
          <h2 class="text-xl font-black text-white uppercase tracking-tight">Personnel Activity</h2>
        </div>
        <div class="p-6 space-y-4">
          <% @top_users.each do |user_data, visits_count| %>
            <div class="flex items-center justify-between p-4 bg-gray-900/50 rounded-xl border border-gray-700/50">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600/20 rounded-lg flex items-center justify-center font-bold text-indigo-400">
                  <%= user_data[1].first %>
                </div>
                <div>
                  <p class="text-white font-bold"><%= user_data[1] %></p>
                  <p class="text-gray-500 text-xs">ID: #<%= user_data[0] %></p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-white font-black"><%= visits_count %></p>
                <p class="text-gray-500 text-[10px] uppercase font-bold">Sessions</p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("turbo:load", function() {
  const ctx = document.getElementById('visitsChart');
  if (ctx) {
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: <%= raw @visit_chart_data[:labels].to_json %>,
        datasets: [{
          label: 'Daily Visits',
          data: <%= @visit_chart_data[:values].to_json %>,
          borderColor: '#6366f1',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointBackgroundColor: '#6366f1',
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255, 255, 255, 0.05)' },
            ticks: { color: '#9ca3af' }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#9ca3af' }
          }
        }
      }
    });
  }
});
</script>
